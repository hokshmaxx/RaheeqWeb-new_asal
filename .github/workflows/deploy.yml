#name: Deploy Laravel App to EC2 with phpMyAdmin
#
#on:
#  push:
#    branches: [master]
#
#jobs:
#  deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout Code
#        uses: actions/checkout@v3
#
#      - name: Setup SSH
#        run: |
#          mkdir -p ~/.ssh
#          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
#          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
#          chmod 600 ~/.ssh/id_rsa
#          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
#
#      - name: Deploy to EC2
#        run: |
#          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
#          set -ex
#
#          # Configuration variables
#          DOMAIN="raheeq.app"
#          EMAIL="hokshmax1@gmail.com"
#          APP_DIR="/var/www/html/raheeq"
#          PHPMYADMIN_DIR="/usr/share/phpmyadmin"
#          PHPMYADMIN_ALIAS="/phpmyadmin"
#          DB_NAME="laravel"
#          DB_USER="laraveluser"
#          DB_PASS="securepassword"
#          PHPMYADMIN_USER="admin"
#          PHPMYADMIN_PASS="SecurePhpMyAdminPass123!"
#
#          echo "ğŸš€ Starting deployment..."
#
#          # 1. Update system and install PHP 7.4 for better compatibility
#          echo "ğŸ“¦ Installing system packages with PHP 7.4..."
#          sudo apt-get update
#
#          # Add PHP repository for PHP 7.4
#          sudo apt-get install -y software-properties-common
#          sudo add-apt-repository ppa:ondrej/php -y
#          sudo apt-get update
#
#          # Install PHP 7.4 and required extensions
#          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
#            nginx \
#            php7.4-fpm \
#            php7.4-mysql \
#            php7.4-cli \
#            php7.4-mbstring \
#            php7.4-xml \
#            php7.4-curl \
#            php7.4-gd \
#            php7.4-zip \
#            php7.4-bcmath \
#            php7.4-json \
#            php7.4-tokenizer \
#            php7.4-intl \
#            php7.4-soap \
#            php7.4-redis \
#            php7.4-common \
#            php7.4-opcache \
#            unzip \
#            git \
#            wget \
#            mariadb-server \
#            certbot \
#            python3-certbot-nginx
#
#          # Set PHP 7.4 as default
#          sudo update-alternatives --set php /usr/bin/php7.4
#
#          # Disable other PHP versions if they exist
#          sudo systemctl stop php8.*-fpm 2>/dev/null || true
#          sudo systemctl disable php8.*-fpm 2>/dev/null || true
#
#          # Get PHP version for later use (should be 7.4 now)
#          PHP_VERSION="7.4"
#          echo "ğŸ“‹ Using PHP version: $PHP_VERSION"
#
#          # 2. Install phpMyAdmin
#          echo "ğŸ—„ï¸ Installing phpMyAdmin..."
#          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y phpmyadmin
#
#          # 3. Install Composer
#          echo "ğŸ¼ Installing Composer..."
#          if ! command -v composer &> /dev/null; then
#            EXPECTED_CHECKSUM="$(wget -q -O - https://composer.github.io/installer.sig)"
#            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
#            ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"
#            if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
#                >&2 echo 'ERROR: Invalid installer checksum'
#                rm composer-setup.php
#                exit 1
#            fi
#            sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
#            rm composer-setup.php
#          fi
#
#          # 4. Setup MariaDB
#          echo "ğŸ—ƒï¸ Setting up MariaDB..."
#          sudo systemctl start mariadb
#          sudo systemctl enable mariadb
#
#          # Create database and user
#          sudo mysql -u root <<EOSQL || true
#          CREATE DATABASE IF NOT EXISTS $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
#          CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
#          GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
#          FLUSH PRIVILEGES;
#          EOSQL
#
#          # 5. Clone or update Laravel application
#          echo "ğŸ“¥ Setting up Laravel application..."
#          if [ ! -d "$APP_DIR" ]; then
#            sudo git clone https://github.com/hokshmaxx/RaheeqWeb-new_asal.git $APP_DIR
#            sudo chown -R $USER:$USER $APP_DIR
#            cd $APP_DIR
#            if [ -f .env.example ]; then
#              cp .env.example .env
#            fi
#          else
#            cd $APP_DIR
#            sudo chown -R $USER:$USER $APP_DIR
#            git fetch origin
#            git reset --hard origin/master
#          fi
#
#          # 6. Configure Laravel environment
#          echo "âš™ï¸ Configuring Laravel environment..."
#          cd $APP_DIR
#
#          # Update .env file
#          if [ -f .env ]; then
#            sed -i "s/^DB_HOST=.*/DB_HOST=127.0.0.1/" .env
#            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" .env
#            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" .env
#            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/" .env
#            sed -i "s/^APP_URL=.*/APP_URL=https:\/\/$DOMAIN/" .env
#          fi
#
#          # 7. Install Laravel dependencies (should work perfectly with PHP 7.4)
#          echo "ğŸ“¦ Installing Laravel dependencies..."
#
#          # Standard installation should work fine with PHP 7.4
#          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
#
#          # Generate application key if not exists
#          if ! grep -q "APP_KEY=" .env || [ -z "$(grep "APP_KEY=" .env | cut -d'=' -f2)" ]; then
#            php artisan key:generate --force
#          fi
#
#          # Run Laravel setup commands
#          php artisan config:clear
#          php artisan cache:clear
#          php artisan route:clear
#          php artisan view:clear
#
#          # Run migrations
#          php artisan migrate --force || echo "âš ï¸ Migration failed, continuing..."
#
#          # MODIFIED: Skip route caching if there are duplicate route names
#          echo "ğŸ” Checking for route conflicts..."
#          if php artisan route:cache 2>&1 | grep -q "Another route has already been assigned name"; then
#            echo "âš ï¸ Duplicate route names detected. Skipping route caching for now."
#            echo "ğŸ“ Please fix duplicate route names in your Laravel application:"
#            php artisan route:list --name=admin.admins.edit_password 2>/dev/null || echo "   Check routes/web.php and routes/admin.php for duplicate route names"
#          else
#            php artisan route:cache
#            echo "âœ… Routes cached successfully"
#          fi
#
#          # Cache config and views (these should work fine)
#          php artisan config:cache
#          php artisan view:cache
#
#          # 8. Setup phpMyAdmin configuration
#          echo "ğŸ”§ Configuring phpMyAdmin..."
#
#          # Create phpMyAdmin config
#          sudo tee $PHPMYADMIN_DIR/config.inc.php > /dev/null <<PHPCONFIG
#          <?php
#          \$cfg['blowfish_secret'] = '$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)';
#          \$i = 0;
#
#          \$i++;
#          \$cfg['Servers'][\$i]['auth_type'] = 'cookie';
#          \$cfg['Servers'][\$i]['host'] = 'localhost';
#          \$cfg['Servers'][\$i]['compress'] = false;
#          \$cfg['Servers'][\$i]['AllowNoPassword'] = false;
#
#          \$cfg['DefaultLang'] = 'en';
#          \$cfg['ServerDefault'] = 1;
#          \$cfg['UploadDir'] = '';
#          \$cfg['SaveDir'] = '';
#          ?>
#          PHPCONFIG
#
#          # Create symlink for phpMyAdmin
#          sudo mkdir -p $APP_DIR/public
#          sudo rm -f $APP_DIR/public$PHPMYADMIN_ALIAS
#          sudo ln -sf $PHPMYADMIN_DIR $APP_DIR/public$PHPMYADMIN_ALIAS
#
#          # 9. Set proper permissions
#          echo "ğŸ” Setting permissions..."
#          sudo chown -R www-data:www-data $APP_DIR
#          sudo chown -R www-data:www-data $PHPMYADMIN_DIR
#          sudo chmod -R 755 $APP_DIR/storage
#          sudo chmod -R 755 $APP_DIR/bootstrap/cache
#          sudo chmod -R 755 $PHPMYADMIN_DIR
#
#          # 10. Configure Nginx
#          echo "ğŸŒ Configuring Nginx..."
#          sudo tee /etc/nginx/sites-available/laravel.conf > /dev/null <<NGINXCONFIG
#          server {
#              listen 80;
#              server_name $DOMAIN www.$DOMAIN;
#
#              root $APP_DIR/public;
#              index index.php index.html index.htm;
#
#              # Security headers
#              add_header X-Frame-Options "SAMEORIGIN" always;
#              add_header X-XSS-Protection "1; mode=block" always;
#              add_header X-Content-Type-Options "nosniff" always;
#              add_header Referrer-Policy "no-referrer-when-downgrade" always;
#              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
#
#              # Laravel application
#              location / {
#                  try_files \$uri \$uri/ /index.php?\$query_string;
#              }
#
#              # phpMyAdmin
#              location $PHPMYADMIN_ALIAS {
#                  alias $PHPMYADMIN_DIR;
#                  index index.php;
#
#                  location ~ ^$PHPMYADMIN_ALIAS/(.+\.php)\$ {
#                      alias $PHPMYADMIN_DIR/\$1;
#                      include snippets/fastcgi-php.conf;
#                      fastcgi_pass unix:/run/php/php$PHP_VERSION-fpm.sock;
#                      fastcgi_param SCRIPT_FILENAME \$request_filename;
#                      fastcgi_param PATH_INFO \$fastcgi_path_info;
#                      fastcgi_param PATH_TRANSLATED \$document_root\$fastcgi_path_info;
#                  }
#
#                  location ~* ^$PHPMYADMIN_ALIAS/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))\$ {
#                      alias $PHPMYADMIN_DIR/\$1;
#                      expires 1y;
#                      add_header Cache-Control "public, immutable";
#                  }
#              }
#
#              # PHP files for Laravel
#              location ~ \.php\$ {
#                  include snippets/fastcgi-php.conf;
#                  fastcgi_pass unix:/run/php/php$PHP_VERSION-fpm.sock;
#                  fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
#                  fastcgi_param DOCUMENT_ROOT \$realpath_root;
#              }
#
#              # Deny access to hidden files
#              location ~ /\. {
#                  deny all;
#              }
#
#              # Deny access to Laravel sensitive files
#              location ~ /(\.env|\.git|storage|tests|database|resources/views) {
#                  deny all;
#              }
#
#              # Optimize static files
#              location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)\$ {
#                  expires 1y;
#                  add_header Cache-Control "public, immutable";
#              }
#          }
#          NGINXCONFIG
#
#          # Enable the site and disable default
#          sudo ln -sf /etc/nginx/sites-available/laravel.conf /etc/nginx/sites-enabled/
#          sudo rm -f /etc/nginx/sites-enabled/default
#
#          # 11. Configure PHP-FPM
#          echo "ğŸ˜ Configuring PHP-FPM..."
#          sudo sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/$PHP_VERSION/fpm/php.ini
#          sudo sed -i 's/upload_max_filesize = .*/upload_max_filesize = 100M/' /etc/php/$PHP_VERSION/fpm/php.ini
#          sudo sed -i 's/post_max_size = .*/post_max_size = 100M/' /etc/php/$PHP_VERSION/fpm/php.ini
#          sudo sed -i 's/max_execution_time = .*/max_execution_time = 300/' /etc/php/$PHP_VERSION/fpm/php.ini
#          sudo sed -i 's/memory_limit = .*/memory_limit = 512M/' /etc/php/$PHP_VERSION/fpm/php.ini
#
#          # 12. Test and start services
#          echo "ğŸ”„ Starting services..."
#          sudo systemctl enable nginx
#          sudo systemctl enable php7.4-fpm
#          sudo systemctl enable mariadb
#
#          sudo systemctl restart php7.4-fpm
#          sudo systemctl restart mariadb
#
#          # Test Nginx configuration
#          if sudo nginx -t; then
#              sudo systemctl restart nginx
#              echo "âœ… Nginx configuration is valid"
#          else
#              echo "âŒ Nginx configuration error"
#              exit 1
#          fi
#
#          # 13. Setup SSL with Certbot
#          echo "ğŸ”’ Setting up SSL certificate..."
#          sudo certbot --nginx --non-interactive --agree-tos --redirect -m $EMAIL -d $DOMAIN -d www.$DOMAIN || {
#              echo "âš ï¸ SSL setup failed, continuing without SSL"
#          }
#
#          # 14. Create phpMyAdmin htaccess protection (optional)
#          echo "ğŸ” Setting up phpMyAdmin password protection..."
#          sudo tee $APP_DIR/public$PHPMYADMIN_ALIAS/.htaccess > /dev/null <<HTACCESS
#          AuthType Basic
#          AuthName "phpMyAdmin Access"
#          AuthUserFile /etc/phpmyadmin/.htpasswd
#          Require valid-user
#          HTACCESS
#
#          # Create htpasswd file
#          sudo mkdir -p /etc/phpmyadmin
#          echo "$PHPMYADMIN_USER:$(openssl passwd -apr1 $PHPMYADMIN_PASS)" | sudo tee /etc/phpmyadmin/.htpasswd
#
#          # 15. Final permissions check
#          echo "ğŸ”§ Final permission adjustments..."
#          sudo chown -R www-data:www-data $APP_DIR
#          sudo chown -R www-data:www-data $PHPMYADMIN_DIR
#          sudo chmod -R 755 $APP_DIR/storage
#          sudo chmod -R 755 $APP_DIR/bootstrap/cache
#          sudo find $APP_DIR -type f -name "*.php" -exec chmod 644 {} \;
#
#          # 16. Clean up
#          echo "ğŸ§¹ Cleaning up..."
#          sudo apt-get autoremove -y
#          sudo apt-get autoclean
#
#          # 17. Display final information
#          echo ""
#          echo "âœ… =================================="
#          echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
#          echo "âœ… =================================="
#          echo ""
#          echo "ğŸŒ Application URL: https://$DOMAIN"
#          echo "ğŸ—„ï¸ phpMyAdmin URL: https://$DOMAIN$PHPMYADMIN_ALIAS"
#          echo ""
#          echo "ğŸ“‹ Database Information:"
#          echo "   Database: $DB_NAME"
#          echo "   Username: $DB_USER"
#          echo "   Password: $DB_PASS"
#          echo ""
#          echo "ğŸ” phpMyAdmin Credentials:"
#          echo "   Username: $PHPMYADMIN_USER"
#          echo "   Password: $PHPMYADMIN_PASS"
#          echo ""
#          echo "ğŸ”§ Services Status:"
#          sudo systemctl is-active nginx && echo "   âœ… Nginx: Running" || echo "   âŒ Nginx: Not Running"
#          sudo systemctl is-active php7.4-fpm && echo "   âœ… PHP 7.4-FPM: Running" || echo "   âŒ PHP 7.4-FPM: Not Running"
#          sudo systemctl is-active mariadb && echo "   âœ… MariaDB: Running" || echo "   âŒ MariaDB: Not Running"
#          echo ""
#          echo "ğŸ“ To troubleshoot issues, check logs:"
#          echo "   Nginx: sudo tail -f /var/log/nginx/error.log"
#          echo "   PHP-FPM: sudo tail -f /var/log/php7.4-fpm.log"
#          echo "   MariaDB: sudo tail -f /var/log/mysql/error.log"
#          echo ""
#
#          # Test URLs
#          echo "ğŸ§ª Testing application..."
#          if curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200\|301\|302"; then
#              echo "   âœ… Laravel application is responding"
#          else
#              echo "   âš ï¸ Laravel application may have issues"
#          fi
#
#          if curl -s -o /dev/null -w "%{http_code}" http://localhost$PHPMYADMIN_ALIAS/ | grep -q "200\|401"; then
#              echo "   âœ… phpMyAdmin is accessible"
#          else
#              echo "   âš ï¸ phpMyAdmin may have issues"
#          fi
#
#          echo ""
#          echo "âš ï¸ IMPORTANT: If route caching was skipped, please fix duplicate route names in your Laravel application."
#          echo "   You can check for duplicates by running: php artisan route:list | grep 'admin.admins.edit_password'"
#          echo ""
#          echo "ğŸ‰ Deployment completed! Your Laravel application with phpMyAdmin is ready!"
#          EOF
name: Deploy Laravel App to EC2 with phpMyAdmin

on:
  push:
    branches: [master]  # Support both branches
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -ex

          # Configuration variables
          DOMAIN="raheeq.app"
          EMAIL="hokshmax1@gmail.com"
          APP_DIR="/var/www/html/raheeq"
          PHPMYADMIN_DIR="/usr/share/phpmyadmin"
          PHPMYADMIN_ALIAS="/phpmyadmin"
          DB_NAME="laravel"
          DB_USER="laraveluser"
          DB_PASS="securepassword"
          PHPMYADMIN_USER="admin"
          PHPMYADMIN_PASS="SecurePhpMyAdminPass123!"

          echo "ğŸš€ Starting deployment at $(date)..."

          # 1. Update system and install PHP 7.4 for better compatibility
          echo "ğŸ“¦ Installing system packages with PHP 7.4..."
          sudo apt-get update

          # Add PHP repository for PHP 7.4
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt-get update

          # Install PHP 7.4 and required extensions
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            nginx \
            php7.4-fpm \
            php7.4-mysql \
            php7.4-cli \
            php7.4-mbstring \
            php7.4-xml \
            php7.4-curl \
            php7.4-gd \
            php7.4-zip \
            php7.4-bcmath \
            php7.4-json \
            php7.4-tokenizer \
            php7.4-intl \
            php7.4-soap \
            php7.4-redis \
            php7.4-common \
            php7.4-opcache \
            unzip \
            git \
            wget \
            mariadb-server \
            certbot \
            python3-certbot-nginx

          # Set PHP 7.4 as default
          sudo update-alternatives --set php /usr/bin/php7.4

          # Disable other PHP versions if they exist
          sudo systemctl stop php8.*-fpm 2>/dev/null || true
          sudo systemctl disable php8.*-fpm 2>/dev/null || true

          # Get PHP version for later use (should be 7.4 now)
          PHP_VERSION="7.4"
          echo "ğŸ“‹ Using PHP version: $PHP_VERSION"

          # 2. Install phpMyAdmin
          echo "ğŸ—„ï¸ Installing phpMyAdmin..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y phpmyadmin

          # 3. Install Composer
          echo "ğŸ¼ Installing Composer..."
          if ! command -v composer &> /dev/null; then
            EXPECTED_CHECKSUM="$(wget -q -O - https://composer.github.io/installer.sig)"
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"
            if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
                >&2 echo 'ERROR: Invalid installer checksum'
                rm composer-setup.php
                exit 1
            fi
            sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            rm composer-setup.php
          fi

          # 4. Setup MariaDB
          echo "ğŸ—ƒï¸ Setting up MariaDB..."
          sudo systemctl start mariadb
          sudo systemctl enable mariadb

          # Create database and user
          sudo mysql -u root <<EOSQL || true
          CREATE DATABASE IF NOT EXISTS $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
          CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
          GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
          FLUSH PRIVILEGES;
          EOSQL

          # 5. Clone or update Laravel application
          echo "ğŸ“¥ Setting up Laravel application..."
          if [ ! -d "$APP_DIR" ]; then
            sudo git clone https://github.com/hokshmaxx/RaheeqWeb-new_asal.git $APP_DIR
            sudo chown -R $USER:$USER $APP_DIR
            cd $APP_DIR
            if [ -f .env.example ]; then
              cp .env.example .env
            fi
          else
            # IMPROVED GIT PULL SECTION
            echo "ğŸ“¥ Updating application code..."
            cd $APP_DIR
            sudo chown -R $USER:$USER $APP_DIR

            # Stash any local changes to prevent conflicts
            git stash push -m "Auto-stash before deployment $(date)" || true

            # Fetch latest changes
            git fetch origin

            # Get the current branch name
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "Current branch: $CURRENT_BRANCH"

            # Pull latest changes
            if [ "$CURRENT_BRANCH" = "master" ] || [ "$CURRENT_BRANCH" = "main" ]; then
                git pull origin $CURRENT_BRANCH
            else
                echo "âš ï¸ Warning: Not on master/main branch. Switching to master..."
                git checkout master || git checkout main
                CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
                git pull origin $CURRENT_BRANCH
            fi
          fi

          # DEBUGGING SECTION
          echo "ğŸ” DEPLOYMENT DEBUGGING INFO"
          echo "================================"
          echo "ğŸ“… Deployment Time: $(date)"
          echo "ğŸ“‚ Working Directory: $(pwd)"
          echo "ğŸŒ¿ Current Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "ğŸ“ Latest Commit: $(git log --oneline -1)"
          echo "ğŸ“ Remote URL: $(git remote get-url origin)"
          echo "ğŸ”„ Git Status:"
          git status --porcelain
          echo ""
          echo "ğŸ—‚ï¸ Directory Contents:"
          ls -la
          echo "================================"

          # 6. Configure Laravel environment
          echo "âš™ï¸ Configuring Laravel environment..."
          cd $APP_DIR

          # Update .env file
          if [ -f .env ]; then
            sed -i "s/^DB_HOST=.*/DB_HOST=127.0.0.1/" .env
            sed -i "s/^DB_DATABASE=.*/DB_DATABASE=$DB_NAME/" .env
            sed -i "s/^DB_USERNAME=.*/DB_USERNAME=$DB_USER/" .env
            sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$DB_PASS/" .env
            sed -i "s/^APP_URL=.*/APP_URL=https:\/\/$DOMAIN/" .env

            echo "ğŸ“‹ Environment File Check:"
            echo "âœ… .env file exists"
            echo "ğŸ”§ Database Config from .env:"
            grep "^DB_" .env || echo "âŒ No DB config found"
            echo "ğŸŒ App URL from .env:"
            grep "^APP_URL" .env || echo "âŒ No APP_URL found"
          else
            echo "âŒ .env file missing!"
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "âœ… Created .env from .env.example"
            fi
          fi

          # 7. Install Laravel dependencies
          echo "ğŸ“¦ Installing Laravel dependencies..."
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

          # Generate application key if not exists
          if ! grep -q "APP_KEY=" .env || [ -z "$(grep "APP_KEY=" .env | cut -d'=' -f2-)" ]; then
            php artisan key:generate --force
          fi

          # ENHANCED CACHE CLEARING
          echo "ğŸ§¹ Clearing all caches thoroughly..."

          # Clear all Laravel caches
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan event:clear

          # Clear opcache if enabled
          if php -m | grep -i opcache; then
            echo "Clearing OPcache..."
            sudo systemctl reload php7.4-fpm
          fi

          # Run migrations
          php artisan migrate --force || echo "âš ï¸ Migration failed, continuing..."

          # Regenerate optimized files
          php artisan config:cache
          php artisan view:cache

          # Only cache routes if no duplicates exist
          echo "ğŸ” Checking for route conflicts..."
          ROUTE_CHECK=$(php artisan route:list 2>&1)
          if echo "$ROUTE_CHECK" | grep -q "Another route has already been assigned name"; then
            echo "âš ï¸ Duplicate route names detected. Routes will NOT be cached."
            echo "ğŸ“ Fix these duplicate routes in your application:"
            echo "$ROUTE_CHECK" | grep "Another route has already been assigned name" | head -5
          else
            php artisan route:cache
            echo "âœ… Routes cached successfully"
          fi

          # Optimize autoloader
          composer dump-autoload --optimize --no-dev

          echo "âœ… Cache clearing completed"

          # 8. Setup phpMyAdmin configuration
          echo "ğŸ”§ Configuring phpMyAdmin..."

          # Create phpMyAdmin config
          sudo tee $PHPMYADMIN_DIR/config.inc.php > /dev/null <<PHPCONFIG
          <?php
          \$cfg['blowfish_secret'] = '$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)';
          \$i = 0;

          \$i++;
          \$cfg['Servers'][\$i]['auth_type'] = 'cookie';
          \$cfg['Servers'][\$i]['host'] = 'localhost';
          \$cfg['Servers'][\$i]['compress'] = false;
          \$cfg['Servers'][\$i]['AllowNoPassword'] = false;

          \$cfg['DefaultLang'] = 'en';
          \$cfg['ServerDefault'] = 1;
          \$cfg['UploadDir'] = '';
          \$cfg['SaveDir'] = '';
          ?>
          PHPCONFIG

          # Create symlink for phpMyAdmin
          sudo mkdir -p $APP_DIR/public
          sudo rm -f $APP_DIR/public$PHPMYADMIN_ALIAS
          sudo ln -sf $PHPMYADMIN_DIR $APP_DIR/public$PHPMYADMIN_ALIAS

          # ENHANCED PERMISSIONS SETUP
          echo "ğŸ” Setting proper permissions..."

          # Ensure correct ownership
          sudo chown -R www-data:www-data $APP_DIR
          sudo chown -R www-data:www-data $PHPMYADMIN_DIR

          # Set proper directory permissions
          find $APP_DIR -type d -exec chmod 755 {} \;

          # Set proper file permissions
          find $APP_DIR -type f -exec chmod 644 {} \;

          # Special permissions for Laravel
          chmod -R 775 $APP_DIR/storage
          chmod -R 775 $APP_DIR/bootstrap/cache

          # Make artisan executable
          chmod +x $APP_DIR/artisan

          # Verify critical directories exist and are writable
          for dir in "storage/logs" "storage/framework/cache" "storage/framework/sessions" "storage/framework/views" "bootstrap/cache"; do
            if [ ! -d "$APP_DIR/$dir" ]; then
              echo "ğŸ“ Creating directory: $dir"
              mkdir -p "$APP_DIR/$dir"
            fi
            chmod 775 "$APP_DIR/$dir"
            chown www-data:www-data "$APP_DIR/$dir"
          done

          echo "âœ… Permissions set correctly"

          # 10. Configure Nginx
          echo "ğŸŒ Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/laravel.conf > /dev/null <<NGINXCONFIG
          server {
              listen 80;
              server_name $DOMAIN www.$DOMAIN;

              root $APP_DIR/public;
              index index.php index.html index.htm;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

              # Laravel application
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              # phpMyAdmin
              location $PHPMYADMIN_ALIAS {
                  alias $PHPMYADMIN_DIR;
                  index index.php;

                  location ~ ^$PHPMYADMIN_ALIAS/(.+\.php)\$ {
                      alias $PHPMYADMIN_DIR/\$1;
                      include snippets/fastcgi-php.conf;
                      fastcgi_pass unix:/run/php/php$PHP_VERSION-fpm.sock;
                      fastcgi_param SCRIPT_FILENAME \$request_filename;
                      fastcgi_param PATH_INFO \$fastcgi_path_info;
                      fastcgi_param PATH_TRANSLATED \$document_root\$fastcgi_path_info;
                  }

                  location ~* ^$PHPMYADMIN_ALIAS/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))\$ {
                      alias $PHPMYADMIN_DIR/\$1;
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }

              # PHP files for Laravel
              location ~ \.php\$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/run/php/php$PHP_VERSION-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
                  fastcgi_param DOCUMENT_ROOT \$realpath_root;
              }

              # Deny access to hidden files
              location ~ /\. {
                  deny all;
              }

              # Deny access to Laravel sensitive files
              location ~ /(\.env|\.git|storage|tests|database|resources/views) {
                  deny all;
              }

              # Optimize static files
              location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)\$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
          NGINXCONFIG

          # Enable the site and disable default
          sudo ln -sf /etc/nginx/sites-available/laravel.conf /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default

          # 11. Configure PHP-FPM
          echo "ğŸ˜ Configuring PHP-FPM..."
          sudo sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/$PHP_VERSION/fpm/php.ini
          sudo sed -i 's/upload_max_filesize = .*/upload_max_filesize = 100M/' /etc/php/$PHP_VERSION/fpm/php.ini
          sudo sed -i 's/post_max_size = .*/post_max_size = 100M/' /etc/php/$PHP_VERSION/fpm/php.ini
          sudo sed -i 's/max_execution_time = .*/max_execution_time = 300/' /etc/php/$PHP_VERSION/fpm/php.ini
          sudo sed -i 's/memory_limit = .*/memory_limit = 512M/' /etc/php/$PHP_VERSION/fpm/php.ini

          # 12. Test and start services
          echo "ğŸ”„ Starting services..."
          sudo systemctl enable nginx
          sudo systemctl enable php7.4-fpm
          sudo systemctl enable mariadb

          sudo systemctl restart php7.4-fpm
          sudo systemctl restart mariadb

          # Test Nginx configuration
          if sudo nginx -t; then
              sudo systemctl restart nginx
              echo "âœ… Nginx configuration is valid"
          else
              echo "âŒ Nginx configuration error"
              sudo nginx -t  # Show the error
              exit 1
          fi

          # 13. Setup SSL with Certbot
          echo "ğŸ”’ Setting up SSL certificate..."
          sudo certbot --nginx --non-interactive --agree-tos --redirect -m $EMAIL -d $DOMAIN -d www.$DOMAIN || {
              echo "âš ï¸ SSL setup failed, continuing without SSL"
          }

          # 14. Create phpMyAdmin htaccess protection (optional)
          echo "ğŸ” Setting up phpMyAdmin password protection..."
          sudo tee $APP_DIR/public$PHPMYADMIN_ALIAS/.htaccess > /dev/null <<HTACCESS
          AuthType Basic
          AuthName "phpMyAdmin Access"
          AuthUserFile /etc/phpmyadmin/.htpasswd
          Require valid-user
          HTACCESS

          # Create htpasswd file
          sudo mkdir -p /etc/phpmyadmin
          echo "$PHPMYADMIN_USER:$(openssl passwd -apr1 $PHPMYADMIN_PASS)" | sudo tee /etc/phpmyadmin/.htpasswd

          # 15. Final permissions check
          echo "ğŸ”§ Final permission adjustments..."
          sudo chown -R www-data:www-data $APP_DIR
          sudo chown -R www-data:www-data $PHPMYADMIN_DIR
          sudo chmod -R 755 $APP_DIR/storage
          sudo chmod -R 755 $APP_DIR/bootstrap/cache
          sudo find $APP_DIR -type f -name "*.php" -exec chmod 644 {} \;

          # 16. Clean up
          echo "ğŸ§¹ Cleaning up..."
          sudo apt-get autoremove -y
          sudo apt-get autoclean

          # 17. ENHANCED TESTING AND FINAL STATUS
          echo ""
          echo "ğŸ§ª Testing application..."

          # Test application response
          APP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
          if echo "$APP_STATUS" | grep -q "200\|301\|302"; then
              echo "   âœ… Laravel application is responding (HTTP: $APP_STATUS)"
          else
              echo "   âš ï¸ Laravel application may have issues (HTTP: $APP_STATUS)"
              echo "   ğŸ“‹ Checking Laravel logs:"
              if [ -f "$APP_DIR/storage/logs/laravel.log" ]; then
                  tail -n 5 "$APP_DIR/storage/logs/laravel.log"
              fi
          fi

          # Test phpMyAdmin
          PMA_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost$PHPMYADMIN_ALIAS/)
          if echo "$PMA_STATUS" | grep -q "200\|401"; then
              echo "   âœ… phpMyAdmin is accessible (HTTP: $PMA_STATUS)"
          else
              echo "   âš ï¸ phpMyAdmin may have issues (HTTP: $PMA_STATUS)"
          fi

          # Check file timestamps to confirm update
          echo ""
          echo "ğŸ“… File Update Verification:"
          echo "   Latest file modification:"
          find $APP_DIR -name "*.php" -type f -printf '%T@ %p\n' | sort -n | tail -1 | awk '{print strftime("%Y-%m-%d %H:%M:%S", $1), $2}'

          # Show git information
          echo "ğŸ“ Git Status Verification:"
          cd $APP_DIR
          echo "   Current commit: $(git log --oneline -1)"
          echo "   Last pull time: $(stat -c %y .git/FETCH_HEAD 2>/dev/null || echo 'Unknown')"

          # 18. Display final information
          echo ""
          echo "âœ… =================================="
          echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "âœ… =================================="
          echo ""
          echo "ğŸŒ Application URL: https://$DOMAIN"
          echo "ğŸ—„ï¸ phpMyAdmin URL: https://$DOMAIN$PHPMYADMIN_ALIAS"
          echo ""
          echo "ğŸ“‹ Database Information:"
          echo "   Database: $DB_NAME"
          echo "   Username: $DB_USER"
          echo "   Password: $DB_PASS"
          echo ""
          echo "ğŸ” phpMyAdmin Credentials:"
          echo "   Username: $PHPMYADMIN_USER"
          echo "   Password: $PHPMYADMIN_PASS"
          echo ""
          echo "ğŸ”§ Services Status:"
          sudo systemctl is-active nginx && echo "   âœ… Nginx: Running" || echo "   âŒ Nginx: Not Running"
          sudo systemctl is-active php7.4-fpm && echo "   âœ… PHP 7.4-FPM: Running" || echo "   âŒ PHP 7.4-FPM: Not Running"
          sudo systemctl is-active mariadb && echo "   âœ… MariaDB: Running" || echo "   âŒ MariaDB: Not Running"
          echo ""
          echo "ğŸ“ To troubleshoot issues, check logs:"
          echo "   Nginx: sudo tail -f /var/log/nginx/error.log"
          echo "   PHP-FPM: sudo tail -f /var/log/php7.4-fpm.log"
          echo "   MariaDB: sudo tail -f /var/log/mysql/error.log"
          echo "   Laravel: tail -f $APP_DIR/storage/logs/laravel.log"
          echo ""

          # Final route caching warning
          if [ -n "$ROUTE_CHECK" ] && echo "$ROUTE_CHECK" | grep -q "Another route has already been assigned name"; then
              echo "âš ï¸ IMPORTANT: Route caching was skipped due to duplicate route names."
              echo "   Please fix these duplicate routes in your Laravel application:"
              echo "   You can check for duplicates by running:"
              echo "   cd $APP_DIR && php artisan route:list | grep -E '(admin\.admins\.edit_password|duplicate)'"
              echo ""
          fi

          echo "ğŸ‰ Deployment completed at $(date)!"
          echo "ğŸ‰ Your Laravel application with phpMyAdmin is ready and updated!"
          EOF

      - name: Deployment Summary
        run: |
          echo "ğŸ¯ Deployment triggered by: ${{ github.event.head_commit.message }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
